{% extends 'layout/base.html' %}
{% load static %}

{% block title %}{% endblock %}

{% block style %}
    <style>
        div label:first-child {font-weight: bold}
        #zip1, #zip2 { width: 75px}

    </style>
{% endblock %}

{% block content %}
<div id="main">
    <div class="mt-5">
        <div class="d-flex justify-content-between">
            <h2><i class="bi bi-people-fill"></i> 회원가입</h2>
            <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <span class="badge bg-success p-2">이용약관</span></li>
                <li class="breadcrumb-item">
                    <span class="badge bg-success p-2 ">정보입력</span></li>
                <li class="breadcrumb-item">
                    <span class="badge bg-light p-2 text-secondary">가입완료</span></li>
            </ol>
            </nav>
        </div>
        <hr>
    </div> <!-- // page header -->

    <div class="mx-5">
        <h3><i class="bi bi-pencil"></i> 회원정보 입력</h3>
        <small class="text-muted">회원정보는 개인정보 취급장침에 따라 안전하게 보호되며, 회원님의 명백한 동의없이 공개 또는 제3자에게 제공되지 않습니다.</small>
        <hr>
    </div> <!-- // subtitle -->

    <div class = "card card-body bg-light mx-4 mb-5 ">
        <form name="joinfrm" method="post" class="">
            {% csrf_token %}
            <div class="row mt-5">
                <label for="userid" class="col-form-label col-2 text-end">아이디</label>
                <div class="col-3">
                    <input type="text" name="userid" id="userid" class="form-control" maxlength="20">
                    <div id = "uidmsg" class="text-primary"></div>
                    <div id = "uidmsg2" class="text-danger"></div>

                </div>
                <label class="col-form-label col-7">5~20자의 영문 소문자, 숫자만 사용 가능합니다.</label>
            </div> <!-- // userid -->

            <div class="row mt-3">
                <label for="passwd" class="col-form-label col-2 text-end">비밀번호</label>
                <div class="col-3">
                    <input type="password" name="passwd" id="passwd" class=" form-control" maxlength="18">
                    <div id="pwdmsg2" class="text-danger"></div>
                </div>
                <label class="col-form-label col-7">8~16자의 영문 대 소문자, 숫자, 특수문자를 사용하세요.</label>
            </div> <!-- // passwd -->

            <div class="row mt-3">
                <label for="repwd" class="col-form-label col-2 text-end">비밀번호 확인</label>
                <div class="col-3">
                    <input type="password" name="repwd" id="repwd" class=" form-control" maxlength="18">
                    <div id="pwdmsg" class="text-primary"></div>
                </div>

            </div> <!-- // repasswd -->

            <div class="row mt-3">
                <label for="name" class="col-form-label col-2 text-end">이름</label>
                <div class="col-3">
                     <input type="text" name="name" id="name" class=" form-control">
                </div>
            </div> <!-- // name -->

            <div class="row mt-4" >
                <label for="birth" class="col-form-label col-2 text-end">생년월일</label>
                <div class="col-8 d-flex flex-row">
                    <input type="text" name="birth" id="birth" class="form-control "style="width:150px" placeholder="ㆍ ㆍ ㆍ ㆍ ㆍ ㆍ" maxlength="6">
                     <label class="col-form-label">&nbsp;-&nbsp;</label><input type="text" name="gender" id="gender" class="form-control "style="width:40px" placeholder="ㆍ" maxlength="1"> <label class="col-form-label">&nbsp;ㆍ ㆍ ㆍ ㆍ ㆍ ㆍ</label>
                </div>
            </div><!--//birth/gender-->

            <div class="row mt-3">
                <label for="phone" class="col-form-label col-2 text-end">전화번호</label>
                <div class="col-3">
                     <input type="text" name="phone" id="phone" class=" form-control" placeholder="'-' 없이 숫자만 입력" maxlength="11">
                </div>
            </div> <!-- // phone -->

            <div class="row mt-3">
                <label for="zip1" class="col-form-label col-2 text-end">우편번호</label>
                <div class="col-6 d-flex flex-row">
                     <input type="text" name="zip1" id="zip1" class=" form-control" readonly>
                     <span class="col-form-label">&nbsp;&dash;&nbsp;</span>
                     <input type="text" name="zip2" id="zip2" class=" form-control" readonly>&nbsp;&nbsp;
                     <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#zipmodal">
                         <i class="bi bi-question-circle"></i> 우편번호 검색
                     </button>
                </div>
            </div> <!-- // zipcode -->

            <div class="row mt-3">
                <label for="addr1" class="col-form-label col-2 text-end">주소</label>
                <div class="col-6">
                     <input type="text" name="addr1" id="addr1" class=" form-control" readonly>
                     <input type="text" name="addr2" id="addr2" class=" form-control mt-2">
                </div>
            </div> <!-- // address -->

            <div class="row mt-3">
                <label for="email1" class="col-form-label col-2 text-end">전자우편주소</label>
                <div class="col-7 d-flex flex-row">
                    <div class="input-group">
                        <input type="text" name="email1" id="email1" class=" form-control ">
                        <span class="input-group-text ">@</span>
                        <input type="text" name="email2" id="email2" class=" form-control " readonly>
                    </div>
                    <select class="form-select  w-auto ms-2" id="email3">
                        <option>선택하세요</option>
                        <option>gmail.com</option>
                        <option>hotmail.com</option>
                        <option>naver.com</option>
                        <option>daum.net</option>
                        <option>kakao.com</option>
                        <option>직접입력하기</option>
                    </select>
                </div>
            </div> <!-- // email -->

            <div class="row mt-3">
                <label for="name" class="col-form-label col-2 text-end">자동가입방지</label>
                <div class="col-5">
                    <div class="g-recaptcha" data-sitekey="6LcA26ogAAAAAGWa_f3n0SdPHrN-t2XAJZCLwE7Y"></div>
                    <div class="text-danger">{{ error }}</div>
                </div>
            </div> <!-- // recaptcha -->

            <div class="text-center mt-5">
                <button type="button" class="btn btn-primary" id="okjoin">
                    <i class="bi bi-check"></i> 입력완료</button>
                <button type="reset" class="btn btn-danger" id="nojoin">
                    <i class="bi bi-x"></i> 다시입력</button>
            </div> <!-- // buttons -->

            <input type="hidden" name="seq">
            <input type="hidden" name="ischecked" value="no">
            <input type="hidden" name="ismatched" value="no">

        </form>
    </div>
</div> <!-- // member info -->

<!-- 우편번호 찾기 모달 -->
<div id="zipmodal" aria-hidden="true" class="modal"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">우편번호 찾기</h3>
                <button type="button" data-bs-dismiss="modal"
                        class="btn btn-light">닫기</button>
            </div>

            <div class="modal-body">
                <form name="zipfrm">
                    <div class="row mt-3">
                        <div class="col-1">&nbsp;</div>
                        <div class="col-3">
                            <label for="dong" class="text-end text-danger ms-5 mt-n1">
                                검색할 주소의 동을 입력하세요</label>
                        </div>
                        <div class="col-4">
                            <input type="text" id="dong"
                                   name="dong" class="form-control ">
                        </div>
                        <div class="col-4">
                            <button type="button" class="btn btn-primary" id="dongbtn">
                                <i class="bi bi-search"></i> 검색하기</button>
                        </div>
                        <div class="col-1"></div>
                    </div>

                    <div class="row">
                        <div class="col-1"></div>
                        <div class="col-9">
                            <hr class="col-11 ms-5">
                            <p class="ms-5">지역의 읍/면/동의 이름을 공백없이 입력하신 후, [검색하기] 버튼을 클릭하세요</p>
                            <select id="addrlist" name="addrlist"
                                    size="10" class="form-select ms-5 addrsize">
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" id="sendbtn"
                        class="btn btn-danger">
                    선택하고 닫기</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block script %}
    <script>
        // 이메일 주소 관련 코드
        const email2 = document.querySelector('#email2');
        const email3 = document.querySelector('#email3');

        email3.addEventListener('change', () => {
            if (email3.value == '직접입력하기') {
                email2.value = '';
                email2.readOnly = false;
            }
            else if (email3.value != '선택하세요') {
                email2.value = email3.value;
                email2.readOnly = true;
            }
        });

        // 비밀번호 일치 여부 관련 코드
        const passwd = document.querySelector('#passwd');
        const repwd = document.querySelector('#repwd');
        const pwdmsg = document.querySelector('#pwdmsg');
        const pwdmsg2 = document.querySelector('#pwdmsg2');

        repwd.addEventListener('blur', () => {
            let msg = '비밀번호가 일치합니다!';
            let msg2 = ''
            if (repwd.value != '') {
                document.joinfrm.ismatched.value = 'yes';
                if (passwd.value.length < 8) {
                    msg2 = '비밀번호 형식이 틀립니다!'
                }
                pwdmsg2.innerHTML = msg2;

                if (passwd.value != repwd.value) {
                    msg = '비밀번호가 일치하지 않습니다!';
                    document.joinfrm.ismatched.value = 'no';
                }
                pwdmsg.innerHTML = msg;
            }
        });



        // 우편번호 검색 관련 코드
        const dongbtn = document.querySelector('#dongbtn');
        const sendbtn = document.querySelector('#sendbtn');
        const dong = document.querySelector('#dong');
        const addrlist = document.querySelector('#addrlist');

        // join/zipcode?dong=동이름 으로 주소를 조회
        dongbtn.addEventListener('click', () => {
            let qry = '?dong=' + dong.value;
            fetch('{% url 'zipcode' %}' + qry)
                .then(response => response.text())
                .then(text => setZipcode(text));
        });

        const setZipcode = (dongs) => {

            dongs = JSON.parse(dongs); // 문자열을 JSON객체로 변환

            let opts = '';
            let vals = '';
            let seq = '';
            dongs.forEach((data, idx) => {

                vals = data.fields.zipcode + ' ';
                vals += data.fields.sido + ' ';
                vals += data.fields.gugun + ' ';
                vals += data.fields.dong + ' ';
                vals += data.fields.ri + ' ';
                vals += data.fields.bunji;
                seq = ' ' + data.pk;

                opts += `<option value="${vals}${seq}">`;
                opts += vals;
                opts += '</option>';
            });

            addrlist.innerHTML = '';
            addrlist.innerHTML = opts;
        };

        // 주소 목록에서 주소선택하고 검색창 닫기
        sendbtn.addEventListener('click', () => {

            if (addrlist.value == ''){
                alert('주소를 선택하세요!');
            }
            else {

                let addrs = addrlist.value.split(' ');
                zip1.value = addrs[0].split('-')[0];
                zip2.value = addrs[0].split('-')[1];

                addr1.value = `${addrs[1]} ${addrs[2]} ${addrs[3]}`;
                addr2.value = `${addrs[4]} ${addrs[5]} `;
                document.joinfrm.seq.value = addrs[addrs.length-1];


                // 검색 결과 지운 후 모달창 닫음
                addrlist.innerHTML = '';
                dong.value = '';
                bootstrap.Modal.getInstance('#zipmodal').hide();
            }
        });

        // 아이디 중복 체크 코드
        const userid = document.querySelector('#userid');
        const uidmsg = document.querySelector('#uidmsg');
        const uidmsg2 = document.querySelector('#uidmsg2');

        userid.addEventListener('blur', () => {
            let qry = '?userid=' + userid.value;
            fetch('{% url 'userid' %}' + qry)
                .then(response => response.text())
                .then(text => check_userid(text));
        });

        const check_userid = (result) => {
            let msg = '사용가능한 아이디가 아닙니다!';
            let msg2 = '사용가능한 아이디가 아닙니다!';
            if (userid.value != '') {
                document.joinfrm.ischecked.value = 'no'

                if (userid.value.length >= 5) {
                    if (JSON.parse(result).count == 0) {
                        document.joinfrm.ischecked.value = 'yes'
                        msg = '사용가능한 아이디 입니다!';
                        msg2 = '';
                        uidmsg.innerHTML = msg;
                        uidmsg2.innerHTML = msg2;
                    } else if (JSON.parse(result).count == 1) {
                        msg2 = '중복된 아이디입니다!';
                        msg = '';
                        uidmsg.innerHTML = msg;
                        uidmsg2.innerHTML = msg2;
                    }
                } else {
                    msg = '';
                    uidmsg.innerHTML = msg
                    uidmsg2.innerHTML = msg2;
                }
            }
        };

        const okjoin = document.querySelector('#okjoin');
        // 유효성 검사
        const phonec = /^01[0|1|6|7|8|9]-?\d{3,4}-?\d{4}$/;
        const birthc = /^[0-9]{2}[0-1][0-9][0-3][0-9]$/;
        const genderc = /^[1-4]$/;
        const useridc = /[a-z, 0-9]{5,19}/;

        okjoin.addEventListener('click', () => {
           const frm = document.joinfrm;
           if (frm.userid.value == '') alert('아이디를 작성하세요!');
           else if (frm.ischecked.value == 'no') alert('아이디 중복검사를 하세요!');
           else if (frm.userid.value != useridc.exec(frm.userid.value)) alert('아이디형식을 확인하세요!');
           else if (frm.passwd.value == '') alert('비밀번호를 작성하세요!');
           else if (frm.passwd.value.length < 8) alert('비밀번호형식을 확인하세요!');
           else if (frm.repwd.value == '') alert('비밀번호확인을 작성하세요!');
           else if (frm.ismatched.value == 'no') alert('비밀번호가 일치하는지 확인하세요!');
           else if (frm.name.value == '') alert('이름을 확인하세요!');
           else if (frm.birth.value == '') alert('생년월일를 확인하세요!');
           else if (birthc.test(frm.birth.value) != true) alert('생년월일형식을 확인하세요!');
           else if (frm.gender.value == '') alert('성별을 확인하세요!');
           else if (genderc.test(frm.gender.value) != true) alert('성별을 확인하세요!');
           else if (frm.phone.value == '') alert('전화번호를 확인하세요!');
           else if (phonec.test(frm.phone.value) != true) alert('전화번호형식을 확인하세요!');
           else if (frm.zip1.value == '' || frm.zip2.value == '')  alert('우편번호를 체크하세요!');
           else if (frm.addr1.value == '' || frm.addr2.value == '')  alert('주소를 확인하세요!');
           else if (frm.email1.value == '' || frm.email2.value == '') alert('이메일을 확인하세요!');
           else if (grecaptcha.getResponse() == '') alert('자동가입방지를 체크하세요!');
           else {
               frm.submit();
           }
        });

    </script>
{% endblock %}


